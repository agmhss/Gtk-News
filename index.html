<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gtk NEWS</title>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
  body {
    font-family: "Segoe UI", sans-serif;
    background: #f8fbff;
    color: #111;
    margin: 0;
    padding: 0;
  }
  header {
    background: #2b6bff;
    color: #fff;
    padding: 15px;
    font-size: 22px;
    font-weight: bold;
    text-align: center;
  }
  #controls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    margin: 15px;
  }
  button, select, input[type=range] {
    font-size: 15px;
    padding: 6px 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }
  button {
    background: #2b6bff;
    color: white;
    border: none;
  }
  button:hover { background: #1d4ed8; }
  #news {
    max-width: 800px;
    margin: auto;
    padding: 10px;
  }
  section { margin-top: 25px; }
  h2 { border-bottom: 2px solid #ddd; padding-bottom: 4px; }
  article {
    display: flex;
    gap: 10px;
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 8px;
    background: white;
    margin-bottom: 10px;
  }
  article img {
    width: 90px;
    height: 90px;
    object-fit: cover;
    border-radius: 6px;
  }
  .meta {
    font-size: 12px;
    color: #555;
  }
  a { color: #2b6bff; text-decoration: none; }
  a:hover { text-decoration: underline; }
</style>
</head>
<body>
<header>üóûÔ∏è Gtk NEWS üóûÔ∏è </header>

<div id="controls">
  <button id="playBtn">‚ñ∂ Play</button>
  <button id="pauseBtn">‚è∏ Pause</button>
  <button id="resumeBtn">‚èµ Resume</button>
  <button id="stopBtn">‚èπ Stop</button>
  <label>Voice:
    <select id="voiceGender">
      <option value="male">Male</option>
      <option value="female">Female</option>
    </select>
  </label>
  <label>Speed:
    <input id="speedRange" type="range" min="0.7" max="1.3" step="0.05" value="0.9" />
    <span id="speedLabel">0.9√ó</span>
  </label>
  <button id="pdfBtn">üíæ Save as PDF</button>
</div>

<div id="news">Loading authentic sources‚Ä¶</div>
  
<script>
const FEEDS = {
  regional: ["https://www.thehindu.com/news/national/tamil-nadu/feeder/default.rss"],
  national: [
    "https://feeds.feedburner.com/ndtvnews-top-stories",
    "https://timesofindia.indiatimes.com/rssfeedstopstories.cms"
  ],
  international: ["https://feeds.bbci.co.uk/news/world/rss.xml"]
};
const MIX = { regional: 0.5, national: 0.3, international: 0.2 };
const TOTAL = 10;

// --- Helper functions ---
function stripHtml(html) {
  const div = document.createElement("div");
  div.innerHTML = html || "";
  return (div.textContent || div.innerText || "").replace(/\s+/g, " ").trim();
}
function parseFirstImg(html) {
  const div = document.createElement("div");
  div.innerHTML = html;
  const img = div.querySelector("img");
  return img ? img.src : "";
}
function chooseThumb(it) {
  const thumb = it.querySelector("media\\:thumbnail, thumbnail");
  if (thumb?.getAttribute("url")) return thumb.getAttribute("url");
  const content = it.querySelector("media\\:content");
  if (content?.getAttribute("url")) return content.getAttribute("url");
  const enclosure = it.querySelector("enclosure");
  if (enclosure && (enclosure.getAttribute("type") || "").startsWith("image"))
    return enclosure.getAttribute("url");
  const desc = it.querySelector("description")?.textContent || "";
  return parseFirstImg(desc);
}

// --- FIXED RSS fetcher using allorigins.win ---
async function fetchRSS(url) {
  const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
  const res = await fetch(proxy);
  if (!res.ok) throw new Error("fetch failed");
  const data = await res.json();
  return data.contents; // allorigins wraps RSS in 'contents'
}

async function parseRSS(url) {
  try {
    const xmlStr = await fetchRSS(url);
    const xml = new DOMParser().parseFromString(xmlStr, "application/xml");
    return Array.from(xml.querySelectorAll("item")).map((it, i) => ({
      id: url + "#" + i,
      title: stripHtml(it.querySelector("title")?.textContent || ""),
      description: stripHtml(it.querySelector("description")?.textContent || ""),
      link: it.querySelector("link")?.textContent || "",
      pubDate: it.querySelector("pubDate")?.textContent || "",
      image: chooseThumb(it),
      source: new URL(url).host
    }));
  } catch (e) {
    console.warn("Feed failed", url, e);
    return [];
  }
}

async function loadAll() {
  const lists = await Promise.all([
    parseRSS(FEEDS.regional[0]),
    parseRSS(FEEDS.national[0]).then(r => r.length ? r : parseRSS(FEEDS.national[1])),
    parseRSS(FEEDS.international[0])
  ]);
  const dedupe = (arr, lim) => {
    const seen = new Set();
    const out = [];
    for (const a of arr) {
      const k = a.title.toLowerCase();
      if (!seen.has(k)) {
        seen.add(k);
        out.push(a);
        if (out.length >= lim) break;
      }
    }
    return out;
  };
  return {
    regional: dedupe(lists[0], Math.round(TOTAL * MIX.regional) || 5),
    national: dedupe(lists[1], Math.round(TOTAL * MIX.national) || 3),
    international: dedupe(lists[2], Math.round(TOTAL * MIX.international) || 2)
  };
}

// --- Rendering + Voice + PDF (unchanged) ---
function renderNews(all) {
  const container = document.getElementById("news");
  container.innerHTML = "";
  const createSection = (title, arr) => {
    const sec = document.createElement("section");
    const h2 = document.createElement("h2");
    h2.textContent = title;
    sec.appendChild(h2);
    arr.forEach(a => {
      const art = document.createElement("article");
      if (a.image) {
        const img = document.createElement("img");
        img.src = a.image;
        img.onerror = () => img.remove();
        art.appendChild(img);
      }
      const div = document.createElement("div");
      div.innerHTML = `
        <div class='meta'>${a.source} ${a.pubDate ? "‚Ä¢ " + new Date(a.pubDate).toLocaleString() : ""}</div>
        <h3>${a.title}</h3>
        <p>${a.description}</p>
        <a href='${a.link}' target='_blank'>Read more ‚Üó</a>`;
      art.appendChild(div);
      sec.appendChild(art);
    });
    container.appendChild(sec);
  };
  createSection("Regional ‚Äì Tamil Nadu", all.regional);
  createSection("National ‚Äì India", all.national);
  createSection("International", all.international);
}

// --- Voice + PDF (same as before) ---
function buildScript(n) {
  const date = new Date().toLocaleDateString("en-IN",{year:"numeric",month:"long",day:"numeric"});
  const parts = [`Good day. This is your Daily News bulletin for ${date}.`];
  const add = (label, arr) => {
    if (!arr.length) return;
    parts.push(`${label}.`);
    arr.forEach((it,i)=>{
      const desc = it.description.split(/(?<=[.?!])\s+/)[0] || "";
      parts.push(`${i+1}. ${it.title}. ${desc}`);
    });
  };
  add("Regional ‚Äì Tamil Nadu", n.regional);
  add("National ‚Äì India", n.national);
  add("International", n.international);
  parts.push("That concludes the Daily News bulletin.");
  return parts;
}

function speakNews(news, rate, gender) {
  window.speechSynthesis.cancel();
  const parts = buildScript(news);
  const voices = window.speechSynthesis.getVoices();
  const pref = gender==="male" ?
    ["Microsoft Heera", "Google UK English Male", "Male"] :
    ["Microsoft Neerja", "Google UK English Female", "Female"];
  const voice = voices.find(v=>pref.some(k=>v.name.includes(k))) || voices[0];
  parts.forEach(seg=>{
    const u = new SpeechSynthesisUtterance(seg);
    u.lang="en-IN"; u.rate=rate; u.pitch=gender==="male"?0.95:1.05;
    if(voice)u.voice=voice;
    window.speechSynthesis.speak(u);
  });
}

function saveAsPDF(news) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:"pt"});
  const margin=40, maxW=515; let y=margin;
  const date=new Date().toLocaleDateString("en-IN",{year:"numeric",month:"long",day:"numeric"});
  doc.setFontSize(18); doc.text(`Daily News ‚Äì ${date}`, margin, y); y+=25;
  const write=(txt,fs=12,bold=false)=>{
    doc.setFont(undefined,bold?"bold":"normal"); doc.setFontSize(fs);
    const lines=doc.splitTextToSize(txt,maxW);
    lines.forEach(line=>{
      if(y>770){doc.addPage(); y=margin;}
      doc.text(line, margin, y); y+=fs+4;
    });
  };
  const add=(label,arr)=>{if(!arr.length)return;write(label,14,true);
    arr.forEach((a,i)=>{write(`${i+1}. ${a.title}`,12,true);
      if(a.source||a.pubDate)write(`${a.source||''}${a.pubDate?' ‚Ä¢ '+new Date(a.pubDate).toLocaleString():''}`,10);
      if(a.description)write(a.description,11);
      if(a.link)write(a.link,10); y+=6;});
    y+=6;};
  add("Regional ‚Äì Tamil Nadu",news.regional);
  add("National ‚Äì India",news.national);
  add("International",news.international);
  doc.save(`Daily_News_${date.replace(/\s+/g,'_')}.pdf`);
}

// --- Initialize ---
(async ()=>{
  try {
    const all = await loadAll();
    renderNews(all);
    const play=document.getElementById('playBtn'),
          pause=document.getElementById('pauseBtn'),
          resume=document.getElementById('resumeBtn'),
          stop=document.getElementById('stopBtn'),
          genderSel=document.getElementById('voiceGender'),
          speed=document.getElementById('speedRange'),
          label=document.getElementById('speedLabel'),
          pdfBtn=document.getElementById('pdfBtn');
    let rate=parseFloat(speed.value);
    speed.oninput=()=>{rate=parseFloat(speed.value); label.textContent=rate.toFixed(2)+'√ó';};
    play.onclick=()=>speakNews(all,rate,genderSel.value);
    pause.onclick=()=>speechSynthesis.pause();
    resume.onclick=()=>speechSynthesis.resume();
    stop.onclick=()=>speechSynthesis.cancel();
    pdfBtn.onclick=()=>saveAsPDF(all);
  } catch (e) {
    document.getElementById("news").innerHTML = "<p style='color:red'>Failed to load news feeds. Please try again later.</p>";
  }
})();
    </script>
</body>
</html>
