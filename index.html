import React, { useEffect, useRef, useState } from "react";
import jsPDF from "jspdf"; // NOTE: Removed jspdf-autotable to fix doc.autoTable error

/******************** CONFIG ********************/
const FEEDS = {
  regional: ["https://www.thehindu.com/news/national/tamil-nadu/feeder/default.rss"],
  national: ["https://feeds.feedburner.com/ndtvnews-top-stories", "https://timesofindia.indiatimes.com/rssfeedstopstories.cms"],
  international: ["https://feeds.bbci.co.uk/news/world/rss.xml"],
};

const MIX = { regional: 0.5, national: 0.3, international: 0.2 };
const TOTAL = 10;

/******************** UTILITIES ********************/
function stripHtml(html) {
  const div = document.createElement("div");
  div.innerHTML = html || "";
  return (div.textContent || div.innerText || "").replace(/\s+/g, " ").trim();
}

function dedupeByTitle(items, limit) {
  const seen = new Set();
  const out = [];
  for (const it of items) {
    const key = (it.title || "").toLowerCase();
    if (!seen.has(key)) {
      seen.add(key);
      out.push(it);
    }
    if (out.length >= limit) break;
  }
  return out;
}

/******************** RSS LOADING ********************/
async function fetchRSS(url) {
  const proxied = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
  const res = await fetch(proxied);
  if (!res.ok) throw new Error("Failed to load feed");
  return await res.text();
}

async function parseRSS(url) {
  try {
    const text = await fetchRSS(url);
    const xml = new DOMParser().parseFromString(text, "application/xml");
    const items = Array.from(xml.querySelectorAll("item")).map((it, idx) => ({
      id: `${url}#${idx}`,
      title: stripHtml(it.querySelector("title")?.textContent || ""),
      description: stripHtml(it.querySelector("description")?.textContent || ""),
      link: it.querySelector("link")?.textContent || "",
      pubDate: it.querySelector("pubDate")?.textContent || "",
      source: new URL(url).host,
    }));
    return items;
  } catch (e) {
    console.warn("Feed failed:", url, e);
    return [];
  }
}

async function loadAll() {
  const lists = await Promise.all([
    parseRSS(FEEDS.regional[0]),
    parseRSS(FEEDS.national[0]),
    parseRSS(FEEDS.international[0]),
  ]);
  return {
    regional: dedupeByTitle(lists[0], 5),
    national: dedupeByTitle(lists[1], 3),
    international: dedupeByTitle(lists[2], 2),
  };
}

function buildScript(curated) {
  const dateStr = new Date().toLocaleDateString("en-IN", { year: "numeric", month: "long", day: "numeric" });
  let script = `Good day. This is your Daily News bulletin for ${dateStr}. `;
  const sections = [
    ["Regional ‚Äì Tamil Nadu", curated.regional],
    ["National ‚Äì India", curated.national],
    ["International", curated.international],
  ];
  for (const [title, items] of sections) {
    script += `${title}: `;
    items.forEach((it, i) => {
      const headline = (it.title || "").replace(/\s+/g, " ").trim();
      const desc = (it.description || "").split(/(?<=[.?!])\s+/)[0] || "";
      const add = desc && desc.length > 24 ? `${headline}. ${desc}` : `${headline}.`;
      script += `${i + 1}. ${add} `;
    });
  }
  script += "That concludes the Daily News bulletin.";
  return script;
}

/******************** PDF (no autoTable) ********************/
function saveAsPDF({ title = "Daily News", sections = [] }) {
  const doc = new jsPDF({ orientation: "p", unit: "pt", format: "a4" });
  const margin = 40;
  const pageW = doc.internal.pageSize.getWidth();
  const pageH = doc.internal.pageSize.getHeight();
  let y = margin;

  const dateStr = new Date().toLocaleDateString("en-IN", { year: "numeric", month: "long", day: "numeric" });

  // Header
  doc.setFont("Helvetica", "bold");
  doc.setFontSize(18);
  doc.text(`${title} ‚Äì ${dateStr}`, margin, y);
  y += 24;

  const writeWrapped = (txt, fontSize = 12, bold = false) => {
    doc.setFont("Helvetica", bold ? "bold" : "normal");
    doc.setFontSize(fontSize);
    const maxWidth = pageW - margin * 2;
    const lines = doc.splitTextToSize(txt, maxWidth);
    const lineHeight = fontSize + 4;
    for (const line of lines) {
      if (y > pageH - margin) {
        doc.addPage();
        y = margin;
      }
      doc.text(line, margin, y);
      y += lineHeight;
    }
  };

  for (const section of sections) {
    if (!section?.items?.length) continue;
    // Section title
    writeWrapped(section.title, 14, true);
    // Items
    section.items.forEach((item, idx) => {
      const prefix = `${idx + 1}. `;
      writeWrapped(prefix + (item.title || ""), 12, true);
      if (item.source || item.pubDate) {
        const meta = `${item.source || ""}${item.pubDate ? " ‚Ä¢ " + new Date(item.pubDate).toLocaleString() : ""}`;
        writeWrapped(meta, 10, false);
      }
      if (item.description) writeWrapped(item.description, 11, false);
      if (item.link) writeWrapped(String(item.link), 10, false);
      y += 6; // gap between stories
    });
    y += 6; // gap between sections
  }

  doc.save(`Daily_News_${dateStr.replace(/\s+/g, '_')}.pdf`);
}

/******************** MAIN COMPONENT ********************/
export default function DailyNewsApp() {
  const [news, setNews] = useState({ regional: [], national: [], international: [] });
  const [loading, setLoading] = useState(true);
  const [rate, setRate] = useState(0.9);
  const [voiceGender, setVoiceGender] = useState("male");
  const utterRef = useRef(null);

  useEffect(() => {
    (async () => {
      const all = await loadAll();
      setNews(all);
      setLoading(false);
    })();
  }, []);

  const speak = () => {
    const text = buildScript(news);
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = "en-IN";
    utter.rate = rate;
    // Pick male/female voice more robustly
    const voices = window.speechSynthesis.getVoices();
    const prefer = voiceGender === "male"
      ? ["Microsoft Heera - English (India)", "Google UK English Male", "Male"]
      : ["Microsoft Neerja - English (India)", "Google UK English Female", "Female"];
    const voice = voices.find(v => prefer.some(key => v.name.includes(key))) || voices[0];
    if (voice) utter.voice = voice;
    utter.pitch = voiceGender === "male" ? 0.95 : 1.05;

    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utter);
    utterRef.current = utter;
  };

  const pause = () => window.speechSynthesis.pause();
  const resume = () => window.speechSynthesis.resume();
  const stop = () => window.speechSynthesis.cancel();

  const handleSavePDF = () => {
    saveAsPDF({
      title: "Daily News",
      sections: [
        { title: "Regional ‚Äì Tamil Nadu", items: news.regional },
        { title: "National ‚Äì India", items: news.national },
        { title: "International", items: news.international },
      ],
    });
  };

  return (
    <div className="min-h-screen bg-neutral-50 text-neutral-900">
      <div className="max-w-3xl mx-auto p-4">
        <header className="flex items-center justify-between gap-3">
          <h1 className="text-2xl font-bold">Daily News</h1>
          <button onClick={handleSavePDF} className="px-3 py-1.5 rounded bg-blue-600 text-white">üíæ Save as PDF</button>
        </header>

        {loading ? (
          <p className="mt-6">Loading news...</p>
        ) : (
          <>
            <div className="mt-4 flex flex-wrap gap-2 items-center">
              <button onClick={speak} className="px-3 py-1.5 bg-green-600 text-white rounded">‚ñ∂ Play</button>
              <button onClick={() => window.speechSynthesis.pause()} className="px-3 py-1.5 border rounded">‚è∏ Pause</button>
              <button onClick={() => window.speechSynthesis.resume()} className="px-3 py-1.5 border rounded">‚èµ Resume</button>
              <button onClick={() => window.speechSynthesis.cancel()} className="px-3 py-1.5 border rounded">‚èπ Stop</button>
              <div className="flex items-center gap-2 ml-4">
                <label className="text-sm">Voice:</label>
                <select value={voiceGender} onChange={(e) => setVoiceGender(e.target.value)} className="border rounded px-2 py-1 text-sm">
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                </select>
              </div>
            </div>

            <div className="mt-4 flex items-center gap-2">
              <label className="text-sm">Speed:</label>
              <input type="range" min={0.7} max={1.3} step={0.05} value={rate} onChange={(e) => setRate(parseFloat(e.target.value))} />
              <span className="text-sm">{rate.toFixed(2)}√ó</span>
            </div>

            <NewsSection title="Regional ‚Äì Tamil Nadu" items={news.regional} />
            <NewsSection title="National ‚Äì India" items={news.national} />
            <NewsSection title="International" items={news.international} />
          </>
        )}
      </div>
    </div>
  );
}

function NewsSection({ title, items }) {
  return (
    <section className="mt-6">
      <h2 className="text-lg font-semibold mb-2">{title}</h2>
      <div className="mt-3 grid gap-3">
        {items.map((a) => (
          <article key={a.id} className="p-4 rounded-2xl border border-neutral-200 bg-white">
            <div className="text-xs opacity-60 flex gap-2">
              <span>{a.source || "Source"}</span>
              {a.pubDate && <span>‚Ä¢ {new Date(a.pubDate).toLocaleString()}</span>}
            </div>
            <h3 className="mt-1 font-semibold">{a.title}</h3>
            {a.description && <p className="mt-1 text-sm opacity-90">{a.description}</p>}
            {a.link && (
              <a className="mt-2 inline-block text-sm underline" href={a.link} target="_blank" rel="noreferrer">
                Read more ‚Üó
              </a>
            )}
          </article>
        ))}
        {items.length === 0 && (
          <div className="p-4 rounded-2xl border border-neutral-200 bg-white text-sm">No items found.</div>
        )}
      </div>
    </section>
  );
}

/******************** QUICK SELF-TESTS ********************/
(function selfTests() {
  try {
    // Test PDF generation logic without autoTable
    const tmp = new jsPDF({ unit: "pt" });
    const hasSplit = typeof tmp.splitTextToSize === "function";
    console.assert(hasSplit, "jsPDF.splitTextToSize should exist");

    // Minimal content write test
    const dateStr = new Date().toISOString().slice(0,10);
    tmp.text(`TEST Daily News ${dateStr}` , 40, 40);
    // No exception means pass
    console.info("PDF basic write OK");
  } catch (e) {
    console.warn("PDF self-test failed:", e);
  }
})();
