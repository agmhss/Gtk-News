<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gtk NEWS</title>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
  body {
    font-family: "Segoe UI", sans-serif;
    background: #f8fbff;
    color: #111;
    margin: 0;
    padding: 0;
  }
  header {
    background: #2b6bff;
    color: #fff;
    padding: 15px;
    font-size: 22px;
    font-weight: bold;
    text-align: center;
  }
  #controls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    margin: 15px;
  }
  button, input[type=range] {
    font-size: 15px;
    padding: 6px 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }
  button {
    background: #2b6bff;
    color: white;
    border: none;
  }
  button:hover { background: #1d4ed8; }
  #news {
    max-width: 800px;
    margin: auto;
    padding: 10px;
  }
  section { margin-top: 25px; }
  h2 { border-bottom: 2px solid #ddd; padding-bottom: 4px; }
  article {
    display: flex;
    gap: 10px;
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 8px;
    background: white;
    margin-bottom: 10px;
  }
  article img {
    width: 90px;
    height: 90px;
    object-fit: cover;
    border-radius: 6px;
  }
</style>
</head>
<body>
<header>üóûÔ∏è Gtk NEWS üóûÔ∏è</header>

<div id="controls">
  <button id="playBtn">‚ñ∂ Play</button>
  <button id="pauseBtn">‚è∏ Pause</button>
  <button id="resumeBtn">‚èµ Resume</button>
  <button id="stopBtn">‚èπ Stop</button>
  <label>Speed:
    <input id="speedRange" type="range" min="0.7" max="1.3" step="0.05" value="0.95" />
    <span id="speedLabel">0.95√ó</span>
  </label>
  <button id="pdfBtn">üíæ Save as PDF</button>
</div>

<div id="news">Loading authentic sources‚Ä¶</div>

<script>
const FEEDS = {
  regional: ["https://www.thehindu.com/news/national/tamil-nadu/feeder/default.rss"],
  national: [
    "https://feeds.feedburner.com/ndtvnews-top-stories",
    "https://timesofindia.indiatimes.com/rssfeedstopstories.cms"
  ],
  international: ["https://feeds.bbci.co.uk/news/world/rss.xml"]
};
const MIX = { regional: 0.5, national: 0.3, international: 0.2 };
const TOTAL = 10;

// --- Helpers ---
function stripHtml(html) {
  const div = document.createElement("div");
  div.innerHTML = html || "";
  return (div.textContent || div.innerText || "").replace(/\s+/g, " ").trim();
}
function fetchRSS(url) {
  const proxy = `https://api.codetabs.com/v1/proxy/?quest=${encodeURIComponent(url)}`;
  return fetch(proxy).then(res => res.text());
}
async function parseRSS(url) {
  try {
    const xmlStr = await fetchRSS(url);
    const xml = new DOMParser().parseFromString(xmlStr, "application/xml");
    return Array.from(xml.querySelectorAll("item")).map((it, i) => ({
      id: url + "#" + i,
      title: stripHtml(it.querySelector("title")?.textContent || ""),
      description: stripHtml(it.querySelector("description")?.textContent || "")
    }));
  } catch (e) {
    console.warn("Feed failed", url, e);
    return [];
  }
}
async function loadAll() {
  const lists = await Promise.all([
    parseRSS(FEEDS.regional[0]),
    parseRSS(FEEDS.national[0]).then(r => r.length ? r : parseRSS(FEEDS.national[1])),
    parseRSS(FEEDS.international[0])
  ]);
  const dedupe = (arr, lim) => {
    const seen = new Set(), out = [];
    for (const a of arr) {
      const k = a.title.toLowerCase();
      if (!seen.has(k)) { seen.add(k); out.push(a); if (out.length >= lim) break; }
    }
    return out;
  };
  return {
    regional: dedupe(lists[0], Math.round(TOTAL * MIX.regional) || 5),
    national: dedupe(lists[1], Math.round(TOTAL * MIX.national) || 3),
    international: dedupe(lists[2], Math.round(TOTAL * MIX.international) || 2)
  };
}

// --- Rendering ---
function renderNews(all) {
  const container = document.getElementById("news");
  container.innerHTML = "";
  const makeSection = (title, arr) => {
    const sec = document.createElement("section");
    const h2 = document.createElement("h2"); h2.textContent = title;
    sec.appendChild(h2);
    arr.forEach(a => {
      const art = document.createElement("article");
      const div = document.createElement("div");
      div.innerHTML = `<h3>${a.title}</h3><p>${a.description}</p>`;
      art.appendChild(div);
      sec.appendChild(art);
    });
    container.appendChild(sec);
  };
  makeSection("Regional ‚Äì Tamil Nadu", all.regional);
  makeSection("National ‚Äì India", all.national);
  makeSection("International", all.international);
}

// --- Voice ---
function speakNews(news, rate) {
  window.speechSynthesis.cancel();
  const voices = window.speechSynthesis.getVoices();
  const voice = voices.find(v=>v.name.includes("Google UK English Male"))||voices[0];
  const parts = [
    "Good day. Here are your Gtk News headlines.",
    ...news.regional.map(n=>"Regional: "+n.title+"."),
    ...news.national.map(n=>"National: "+n.title+"."),
    ...news.international.map(n=>"International: "+n.title+"."),
    "That concludes the Gtk News bulletin."
  ];
  parts.forEach(p => {
    const u = new SpeechSynthesisUtterance(p);
    u.lang="en-IN"; u.rate=rate; u.voice=voice;
    window.speechSynthesis.speak(u);
  });
}

// --- PDF (single-page condensed) ---
function saveAsPDF(news) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:"pt"});
  const margin=40, maxW=515; let y=margin;
  const date=new Date().toLocaleDateString("en-IN",{year:"numeric",month:"long",day:"numeric"});
  doc.setFontSize(16); doc.setFont("helvetica","bold");
  doc.text(`Gtk Daily News ‚Äì ${date}`, margin, y); y+=18;
  const write=(txt,fs=11,bold=false)=>{
    doc.setFont("helvetica", bold?"bold":"normal");
    doc.setFontSize(fs);
    const lines=doc.splitTextToSize(txt,maxW);
    for (const line of lines) {
      if (y>800) break; // keep on one page
      doc.text(line, margin, y); y+=fs+2;
    }
  };
  const add=(title,arr)=>{
    if (!arr.length) return;
    write(title,13,true);
    arr.forEach((a,i)=>{ write(`${i+1}. ${a.title}`,11,true);
      if(a.description) write(a.description,10); });
    y+=4;
  };
  add("Regional ‚Äì Tamil Nadu",news.regional);
  add("National ‚Äì India",news.national);
  add("International",news.international);
  doc.save(`Gtk_News_${date.replace(/\s+/g,'_')}.pdf`);
}

// --- Init ---
(async ()=>{
  try {
    const all = await loadAll();
    renderNews(all);
    const play=document.getElementById('playBtn'),
          pause=document.getElementById('pauseBtn'),
          resume=document.getElementById('resumeBtn'),
          stop=document.getElementById('stopBtn'),
          speed=document.getElementById('speedRange'),
          label=document.getElementById('speedLabel'),
          pdfBtn=document.getElementById('pdfBtn');
    let rate=parseFloat(speed.value);
    speed.oninput=()=>{rate=parseFloat(speed.value); label.textContent=rate.toFixed(2)+'√ó';};
    play.onclick=()=>speakNews(all,rate);
    pause.onclick=()=>speechSynthesis.pause();
    resume.onclick=()=>speechSynthesis.resume();
    stop.onclick=()=>speechSynthesis.cancel();
    pdfBtn.onclick=()=>saveAsPDF(all);
  } catch (e) {
    document.getElementById("news").innerHTML = "<p style='color:red'>Failed to load news feeds. Please try again later.</p>";
  }
})();
</script>
</body>
</html>
